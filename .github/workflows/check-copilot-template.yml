# Centralized GitHub Action for ioBroker Copilot Template Version Management
# Version: 0.5.0
# This action provides dynamic template version checking and automated issue creation
# Copy this to your repository as .github/workflows/check-copilot-template.yml

name: Check ioBroker Copilot Template Version

on:
  schedule:
    - cron: '23 3 * * 0'  # Weekly check optimized for off-peak hours (3:23 AM UTC Sunday)
  workflow_dispatch:  # Allow manual triggering

jobs:
  check-template:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Dynamic template version check
        id: version-check
        run: |
          echo "ğŸ” Starting dynamic ioBroker Copilot template version check..."
          
          # Get current version from local copilot instructions
          if [ -f ".github/copilot-instructions.md" ]; then
            CURRENT_VERSION=$(awk '/Version:|Template Version:/ {match($0, /([0-9]+(\.[0-9]+)*)/, arr); if (arr[1] != "") print arr[1]}' .github/copilot-instructions.md | head -1)
            if [ -z "$CURRENT_VERSION" ]; then CURRENT_VERSION="unknown"; fi
            echo "ğŸ“‹ Current local version: $CURRENT_VERSION"
          else
            CURRENT_VERSION="none"
            echo "âŒ No .github/copilot-instructions.md file found"
          fi
          
          # Get latest version from centralized metadata
          echo "ğŸŒ Fetching latest template version from centralized config..."
          LATEST_VERSION=$(curl -s https://raw.githubusercontent.com/DrozmotiX/ioBroker-Copilot-Instructions/main/config/metadata.json | jq -r '.version' 2>/dev/null || echo "unknown")
          if [ -z "$LATEST_VERSION" ] || [ "$LATEST_VERSION" = "null" ]; then
            LATEST_VERSION="unknown"
          fi
          echo "ğŸ“‹ Latest available version: $LATEST_VERSION"
          
          # Determine repository status
          COPILOT_INITIALIZED="false"
          UPDATE_NEEDED="false"
          SETUP_NEEDED="false"
          
          if [ "$CURRENT_VERSION" = "none" ]; then
            echo "ğŸš¨ Repository not initialized for GitHub Copilot"
            SETUP_NEEDED="true"
            UPDATE_NEEDED="true"
          elif [ "$CURRENT_VERSION" = "unknown" ] || [ "$LATEST_VERSION" = "unknown" ]; then
            echo "âš ï¸  Version detection issue - assuming update needed"
            COPILOT_INITIALIZED="true"
            UPDATE_NEEDED="true"
          elif [ "$CURRENT_VERSION" != "$LATEST_VERSION" ]; then
            echo "ğŸ†™ Update available!"
            COPILOT_INITIALIZED="true"
            UPDATE_NEEDED="true"
          else
            echo "âœ… Template is up-to-date"
            COPILOT_INITIALIZED="true"
            UPDATE_NEEDED="false"
          fi
          
          # Set outputs for subsequent steps
          echo "current-version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "latest-version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          echo "update-needed=$UPDATE_NEEDED" >> $GITHUB_OUTPUT
          echo "setup-needed=$SETUP_NEEDED" >> $GITHUB_OUTPUT
          echo "copilot-initialized=$COPILOT_INITIALIZED" >> $GITHUB_OUTPUT
          
          echo "ğŸ“Š Analysis complete:"
          echo "  - Copilot Initialized: $COPILOT_INITIALIZED"
          echo "  - Setup Needed: $SETUP_NEEDED" 
          echo "  - Update Needed: $UPDATE_NEEDED"

      - name: Check for existing Copilot-related issues
        id: check-issue
        if: steps.version-check.outputs.update-needed == 'true'
        uses: actions/github-script@v8
        with:
          script: |
            console.log('ğŸ” Checking for existing Copilot-related issues...');
            
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });
            
            // Look for any existing Copilot template-related issues
            const copilotIssues = issues.filter(issue => {
              const title = issue.title.toLowerCase();
              const hasLabels = issue.labels.some(label => 
                ['copilot-setup', 'template-update', 'automation'].includes(label.name)
              );
              const hasKeywords = title.includes('copilot') && (
                title.includes('template') || 
                title.includes('setup') || 
                title.includes('update') ||
                title.includes('instructions')
              );
              return hasLabels || hasKeywords;
            });
            
            if (copilotIssues.length > 0) {
              console.log(`ğŸ“‹ Found ${copilotIssues.length} existing Copilot-related issue(s):`);
              copilotIssues.forEach(issue => {
                console.log(`  - #${issue.number}: ${issue.title}`);
              });
              
              console.log('â„¹ï¸  Skipping new issue creation - existing Copilot issue(s) found');
              return null;
            }
            
            return 'no-existing-issue';

      - name: Create setup/update issue
        id: create-issue
        if: steps.version-check.outputs.update-needed == 'true' && steps.check-issue.outputs.result == 'no-existing-issue'
        uses: actions/github-script@v8
        with:
          script: |
            const currentVersion = '${{ steps.version-check.outputs.current-version }}';
            const latestVersion = '${{ steps.version-check.outputs.latest-version }}';
            const setupNeeded = '${{ steps.version-check.outputs.setup-needed }}' === 'true';
            
            // Extract repository name from full name
            const repoName = context.repo.repo;
            
            let title, body, labels;
            
            if (setupNeeded) {
              title = 'ğŸ¤– Setup ioBroker GitHub Copilot Instructions';
              labels = ['copilot-setup', 'automation'];
              
              body = `<!-- Auto-generated by centralized GitHub Actions workflow -->
            
            # ğŸ¤– Automated ioBroker Copilot Instructions Setup
            
            **Status**: Repository not initialized for GitHub Copilot
            **Latest Template Version**: \`${latestVersion}\`
            **Repository**: ${context.repo.owner}/${repoName}
            
            ## ğŸš€ Initial Setup Required
            
            **GitHub Copilot**: Please help me set up GitHub Copilot instructions for my ioBroker adapter repository with the centralized automation template.
            
            ### ğŸ”„ Setup Task
            
            \`\`\`
            Set up GitHub Copilot instructions for this ioBroker adapter repository.
            
            TEMPLATE SOURCE:
            - Template: https://raw.githubusercontent.com/DrozmotiX/ioBroker-Copilot-Instructions/main/template.md
            - Version: ${latestVersion}
            - Metadata: https://raw.githubusercontent.com/DrozmotiX/ioBroker-Copilot-Instructions/main/config/metadata.json
            
            SETUP REQUIREMENTS:
            1. Create .github/copilot-instructions.md from the latest template
            2. Remove template comment block (<!-- TEMPLATE FILE --> section)
            3. Customize [CUSTOMIZE] sections with ${repoName}-specific context:
               - Adapter purpose and functionality
               - Target devices/services it connects to
               - Unique configuration requirements
               - Special API patterns or authentication
               - Specific testing scenarios
            4. Store template version ${latestVersion} in copilot-instructions.md (NOT package.json)
            5. Add template source reference
            6. Ensure all ioBroker adapter development patterns are included
            \`\`\`
            
            ## ğŸ¯ ${repoName} Adapter Context
            
            Based on repository analysis, this appears to be an ioBroker adapter for: **${repoName}**
            
            Please customize the [CUSTOMIZE] sections with specific details about:
            - What external system/service this adapter connects to
            - Configuration parameters and their purposes
            - Data types and state structures it creates
            - Any special authentication or API patterns
            - Unique testing requirements or constraints
            
            ## ğŸ“‹ Setup Validation
            
            After setup, confirm:
            - [ ] \`.github/copilot-instructions.md\` created with version ${latestVersion}
            - [ ] Template comment block removed
            - [ ] All \`[CUSTOMIZE]\` sections populated with ${repoName}-specific content
            - [ ] Template source reference included
            - [ ] Enhanced Copilot suggestions working (test in your code editor)
            
            ## ğŸ“š References
            
            - **Template Repository**: https://github.com/DrozmotiX/ioBroker-Copilot-Instructions  
            - **Setup Guide**: https://github.com/DrozmotiX/ioBroker-Copilot-Instructions/blob/main/README.md
            - **Centralized Config**: https://raw.githubusercontent.com/DrozmotiX/ioBroker-Copilot-Instructions/main/config/metadata.json
            
            ---
            *ğŸ¤– This issue was automatically created by the centralized GitHub Actions workflow on ${new Date().toISOString().split('T')[0]}. Weekly monitoring will continue after setup.*`;
            } else {
              title = `ğŸ”„ Update ioBroker Copilot Template to v${latestVersion}`;
              labels = ['template-update', 'automation'];
              
              body = `<!-- Auto-generated by centralized GitHub Actions workflow -->
            
            # ğŸ”„ ioBroker Copilot Template Update Available
            
            **Status**: Update Required  
            - **Current Version**: \`${currentVersion}\`
            - **Latest Version**: \`${latestVersion}\`
            - **Repository**: ${context.repo.owner}/${repoName}
            
            ## ğŸš€ Automated Update Process
            
            **GitHub Copilot**: Please help me update my ioBroker Copilot template while preserving all customizations.
            
            ### ğŸ”„ Template Update Task
            
            Use this exact merge process:
            
            \`\`\`
            Update my .github/copilot-instructions.md by merging the latest ioBroker template.
            
            TEMPLATE SOURCE:
            - Template: https://raw.githubusercontent.com/DrozmotiX/ioBroker-Copilot-Instructions/main/template.md
            - Version: ${latestVersion}
            - Metadata: https://raw.githubusercontent.com/DrozmotiX/ioBroker-Copilot-Instructions/main/config/metadata.json
            
            CRITICAL PRESERVATION REQUIREMENTS:
            1. Keep ALL [CUSTOMIZE] sections and their content exactly as they are
            2. Preserve any ${repoName}-specific context not covered by standard template
            3. Maintain custom error handling, API patterns, authentication flows
            4. Keep unique testing scenarios and configuration instructions
            5. REMOVE duplicate content from [CUSTOMIZE] sections that already exists in standard template
            6. Keep only truly unique, adapter-specific content in [CUSTOMIZE] sections
            
            UPDATE REQUIREMENTS:
            1. Integrate latest ioBroker best practices from new template
            2. Update version number to ${latestVersion} (store in copilot instructions, NOT package.json)
            3. Refresh template source reference
            4. Add any new standard sections that are missing
            5. Clean up [CUSTOMIZE] sections to avoid duplicating standard template content
            
            Show me a summary of changes before applying the update.
            \`\`\`
            
            ## ğŸ” What's New in ${latestVersion}
            
            Recent template improvements typically include:
            - ğŸ§ª Enhanced testing patterns and best practices
            - ğŸ›¡ï¸ Improved error handling recommendations
            - ğŸ“ Better documentation generation patterns
            - ğŸ”§ Updated dependency management guidance
            - âš¡ Performance optimization suggestions
            - ğŸ¯ More precise ioBroker-specific code patterns
            
            ## ğŸ”§ Validation Checklist
            
            After update, confirm:
            - [ ] All \`[CUSTOMIZE]\` sections preserved exactly
            - [ ] **Version ${latestVersion} stored in copilot-instructions.md** (NOT package.json)
            - [ ] Custom ${repoName}-specific content intact
            - [ ] New best practices integrated without conflicts
            - [ ] Template source reference updated
            - [ ] Enhanced suggestions working (test in your code editor)
            - [ ] No duplicate content between \`[CUSTOMIZE]\` and standard sections
            
            ## ğŸ›¡ï¸ Safety Features
            
            This automated process:
            - âœ… **Preserves Customizations**: All \`[CUSTOMIZE]\` sections automatically maintained
            - ğŸ”’ **No Data Loss**: Your adapter-specific patterns remain intact
            - ğŸ“‹ **Audit Trail**: All changes tracked in this issue
            - ğŸ”„ **Reversible**: Changes can be reverted if needed
            - ğŸ¯ **Version Control**: Template version stored in copilot instructions (not package.json)
            
            ## ğŸ“š References
            
            - **Template Repository**: https://github.com/DrozmotiX/ioBroker-Copilot-Instructions
            - **Centralized Config**: https://raw.githubusercontent.com/DrozmotiX/ioBroker-Copilot-Instructions/main/config/metadata.json
            - **Update Guide**: https://github.com/DrozmotiX/ioBroker-Copilot-Instructions/blob/main/docs/automated-updates.md
            
            ---
            *ğŸ¤– This issue was automatically created by the centralized GitHub Actions workflow on ${new Date().toISOString().split('T')[0]}. Weekly monitoring continues while preserving your customizations.*`;
            }
            
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: labels
            });
            
            console.log(`âœ… Created issue #${issue.data.number}: ${title}`);
            return issue.data.number;

      - name: Log completion status
        run: |
          echo "ğŸ Centralized template check completed!"
          echo "ğŸ“Š Status Summary:"
          echo "  - Current Version: ${{ steps.version-check.outputs.current-version }}"
          echo "  - Latest Version: ${{ steps.version-check.outputs.latest-version }}"
          echo "  - Copilot Initialized: ${{ steps.version-check.outputs.copilot-initialized }}"
          echo "  - Update Needed: ${{ steps.version-check.outputs.update-needed }}"
          echo "  - Setup Needed: ${{ steps.version-check.outputs.setup-needed }}"
          
          if [ "${{ steps.version-check.outputs.update-needed }}" = "false" ]; then
            echo "âœ… No action required - template is current"
          elif [ "${{ steps.check-issue.outputs.result }}" != "" ] && [ "${{ steps.check-issue.outputs.result }}" != "null" ]; then
            echo "â„¹ï¸  Issue already exists: #${{ steps.check-issue.outputs.result }}"
          else
            echo "ğŸ¯ New automation issue created for repository setup/update"
          fi
          
          echo ""
          echo "ğŸ“ˆ This centralized workflow provides:"
          echo "  âœ¨ Dynamic version checking from metadata.json"
          echo "  ğŸ” Repository status detection"
          echo "  ğŸ¤– Copilot-driven automation (no manual scripts)"
          echo "  ğŸ›¡ï¸ Custom section preservation"
          echo "  ğŸ“… Weekly monitoring"